<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <title>RideSharing DApp (Sepolia)</title>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    input, button, select { margin: 5px 0; padding: 5px; }
    hr { margin: 30px 0; }
  </style>
</head>

<body>

<h1>RideSharing DApp (Sepolia)</h1>

<button onclick="connectWallet()">Connect MetaMask</button>

<p id="account">Not connected</p>

<hr>

<h2>Driver Registration</h2>

<input id="driverName" placeholder="Name"><br>
<input id="driverPlate" placeholder="Plate"><br>
<input id="driverVehicle" placeholder="Vehicle Type"><br>
<input id="driverTariff" placeholder="Tariff (wei)"><br>

<button onclick="registerDriver()">Register Driver</button>

<hr>

<h2>Create Ride (Rider)</h2>

<input id="pickup" placeholder="Pickup"><br>
<input id="destination" placeholder="Destination"><br>

<button onclick="requestRide()">Request Ride</button>

<p><b>Your Ride IDs:</b></p>
<ul id="rideList"></ul>

<hr>

<h2>Accept Ride (Driver)</h2>

<select id="rideDropdown"></select><br>

<button onclick="acceptRide()">Accept Selected Ride</button>

<hr>

<h2>Fund Ride (Rider)</h2>

<input id="fundAmount" placeholder="Amount (wei)"><br>
<button onclick="fundRide()">Fund Selected Ride</button>

<hr>

<h2>Start Ride (Driver)</h2>
<button onclick="startRide()">Start Selected Ride</button>

<hr>

<h2>Confirm Arrival (Rider)</h2>
<button onclick="confirmArrival()">Confirm Arrival</button>

<hr>

<h2>Complete Ride & Pay Driver</h2>
<button onclick="completeRide()">Complete Ride</button>

<script>
let web3;               
let contract;           
let account;            
let selectedRideId;     

const contractAddress = "0xFBcFc6ee4fc2CC72902af228c58e26f5C0d5ef11";

const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "rideId",
				"type": "uint256"
			}
		],
		"name": "acceptRide",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "rideId",
				"type": "uint256"
			}
		],
		"name": "cancelRide",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "rideId",
				"type": "uint256"
			}
		],
		"name": "completeRide",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "rideId",
				"type": "uint256"
			}
		],
		"name": "confirmArrival",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "rideId",
				"type": "uint256"
			}
		],
		"name": "fundRide",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "plate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "vehicleType",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "tariff",
				"type": "uint256"
			}
		],
		"name": "registerDriver",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "pickup",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "destination",
				"type": "string"
			}
		],
		"name": "requestRide",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "rideId",
				"type": "uint256"
			}
		],
		"name": "startRide",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "drivers",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "plate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "vehicleType",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "tariff",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "registered",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "driver",
				"type": "address"
			}
		],
		"name": "getDriver",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "plate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "vehicleType",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "tariff",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "registered",
						"type": "bool"
					}
				],
				"internalType": "struct RideSharing.Driver",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "rideCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "rides",
		"outputs": [
			{
				"internalType": "address",
				"name": "rider",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "driver",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "pickup",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "destination",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "enum RideSharing.RideStatus",
				"name": "status",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

async function connectWallet() {
  // Cek apakah MetaMask terpasang
  if (!window.ethereum) {
    alert("MetaMask not detected");
    return;
  }

  web3 = new Web3(window.ethereum);

  // Request akses akun MetaMask
  const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
  account = accounts[0];

  // Menampilkan alamat wallet
  document.getElementById("account").innerText =
    "Connected: " + account;

  // Inisialisasi smart contract
  contract = new web3.eth.Contract(contractABI, contractAddress);

  // Load daftar ride
  loadRides();
}

// Registrasi driver ke smart contract oleh pengemudi
async function registerDriver() {
  await contract.methods.registerDriver(
    driverName.value,
    driverPlate.value,
    driverVehicle.value,
    driverTariff.value
  ).send({ from: account });

  alert("Driver registered successfully");
}

// Membuat permintaan perjalanan oleh penumpang
async function requestRide() {
  await contract.methods.requestRide(
    pickup.value,
    destination.value
  ).send({ from: account });

  loadRides();
}

// Mengambil semua ride dari smart contract
async function loadRides() {
  const count = await contract.methods.rideCount().call();

  const rideList = document.getElementById("rideList");
  const dropdown = document.getElementById("rideDropdown");

  rideList.innerHTML = "";
  dropdown.innerHTML = "";

  for (let i = 1; i <= count; i++) {
    const ride = await contract.methods.rides(i).call();

    // Jika ride milik penumpang yang login, tampilkan
    if (ride.rider.toLowerCase() === account.toLowerCase()) {
      const li = document.createElement("li");
      li.innerText = `Ride ID ${i} - Status ${ride.status}`;
      rideList.appendChild(li);
    }

    // Tambahkan ke dropdown untuk pengemudi
    const option = document.createElement("option");
    option.value = i;
    option.text = `Ride ID ${i} (status ${ride.status})`;
    dropdown.appendChild(option);
  }

  // Set Ride ID default
  selectedRideId = dropdown.value;
  dropdown.onchange = () => selectedRideId = dropdown.value;
}

// Pengemudi actions
async function acceptRide() {
  await contract.methods.acceptRide(selectedRideId)
    .send({ from: account });
  loadRides();
}

async function startRide() {
  await contract.methods.startRide(selectedRideId)
    .send({ from: account });
  loadRides();
}

async function completeRide() {
  await contract.methods.completeRide(selectedRideId)
    .send({ from: account });
  loadRides();
}

// Penumpang actions
async function fundRide() {
  await contract.methods.fundRide(selectedRideId)
    .send({ from: account, value: fundAmount.value });
  loadRides();
}

async function confirmArrival() {
  await contract.methods.confirmArrival(selectedRideId)
    .send({ from: account });
  loadRides();
}
</script>

</body>
</html>
